import{J as X,r as w,q as m}from"./main-DU5QQqOg.js";import{a as f}from"./index-B9ygI19o.js";const O=X("deals",()=>{const c=w([]),d=w(null),p=w(null),i=w(!1),s=w(null),_=w(""),F=w(null),g=w("all"),D=m(()=>c.value.filter(e=>e.is_active)),x=m(()=>{let e=c.value;if(_.value){const t=_.value.toLowerCase();e=e.filter(l=>{var a,n,r;return((a=l.name)==null?void 0:a.toLowerCase().includes(t))||((n=l.description)==null?void 0:n.toLowerCase().includes(t))||((r=l.client_name)==null?void 0:r.toLowerCase().includes(t))})}return F.value&&(e=e.filter(t=>t.pipeline_id===F.value)),e}),b=m(()=>c.value.length),$=m(()=>D.value.length),C=m(()=>{const e={total:c.value.length,active:0,won:0,lost:0,total_value:0,weighted_value:0};return c.value.forEach(t=>{var l,a;t.is_active&&e.active++,(l=t.stage)!=null&&l.is_won&&e.won++,(a=t.stage)!=null&&a.is_lost&&e.lost++,t.value&&(e.total_value+=parseFloat(t.value)),t.value&&t.probability&&(e.weighted_value+=parseFloat(t.value)*(t.probability/100))}),e});async function k(e={}){var t,l;i.value=!0,s.value=null;try{const a=await f.get("/api/deals",{params:e});return c.value=a.data.data||[],c.value}catch(a){throw s.value=((l=(t=a.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch deals",a}finally{i.value=!1}}async function L(e){var t,l;i.value=!0,s.value=null;try{const a=await f.get(`/api/deals/${e}`);return d.value=a.data.data,d.value}catch(a){throw s.value=((l=(t=a.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch deal",a}finally{i.value=!1}}async function S(e){var t,l;i.value=!0,s.value=null;try{const a=await f.get(`/api/deals/kanban/${e}`);return p.value=a.data.data,p.value}catch(a){throw s.value=((l=(t=a.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch kanban board",a}finally{i.value=!1}}async function A(e=null){var t,l;try{const a=e?{pipeline_id:e}:{};return(await f.get("/api/deals/stats",{params:a})).data.data}catch(a){throw s.value=((l=(t=a.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch statistics",a}}async function E(e=7,t=null){var l,a;try{const n={days:e};return t&&(n.pipeline_id=t),(await f.get("/api/deals/closing-soon",{params:n})).data.data}catch(n){throw s.value=((a=(l=n.response)==null?void 0:l.data)==null?void 0:a.error)||"Failed to fetch closing soon deals",n}}async function I(e=null){var t,l;try{const a=e?{pipeline_id:e}:{};return(await f.get("/api/deals/overdue",{params:a})).data.data}catch(a){throw s.value=((l=(t=a.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch overdue deals",a}}async function T(e){var t,l,a,n;i.value=!0,s.value=null;try{const o=(await f.post("/api/deals",e)).data.data;if(c.value.push(o),p.value&&o.pipeline_id===((t=p.value.pipeline)==null?void 0:t.id)){const u=(l=p.value.columns)==null?void 0:l.find(v=>v.stage.id===o.stage_id);u&&(u.deals.push(o),u.deal_count++,u.total_value+=parseFloat(o.value||0))}return o}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to create deal",r}finally{i.value=!1}}async function j(e,t){var l,a,n;i.value=!0,s.value=null;try{const o=(await f.put(`/api/deals/${e}`,t)).data.data,u=c.value.findIndex(v=>v.id===e);return u!==-1&&(c.value[u]=o),((l=d.value)==null?void 0:l.id)===e&&(d.value=o),o}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to update deal",r}finally{i.value=!1}}async function B(e,t,l=null){var a,n,r;i.value=!0,s.value=null;try{const o={stage_id:t};l!==null&&(o.sort_order=l);const v=(await f.post(`/api/deals/${e}/move`,o)).data.data,h=c.value.findIndex(y=>y.id===e);return h!==-1&&(c.value[h]=v),((a=d.value)==null?void 0:a.id)===e&&(d.value=v),v}catch(o){throw s.value=((r=(n=o.response)==null?void 0:n.data)==null?void 0:r.error)||"Failed to move deal",o}finally{i.value=!1}}async function K(e,t=null){var l,a,n;i.value=!0,s.value=null;try{const r=t?{reason:t}:{},u=(await f.post(`/api/deals/${e}/won`,r)).data.data,v=c.value.findIndex(h=>h.id===e);return v!==-1&&(c.value[v]=u),((l=d.value)==null?void 0:l.id)===e&&(d.value=u),u}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to mark deal as won",r}finally{i.value=!1}}async function P(e,t=null){var l,a,n;i.value=!0,s.value=null;try{const r=t?{reason:t}:{},u=(await f.post(`/api/deals/${e}/lost`,r)).data.data,v=c.value.findIndex(h=>h.id===e);return v!==-1&&(c.value[v]=u),((l=d.value)==null?void 0:l.id)===e&&(d.value=u),u}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to mark deal as lost",r}finally{i.value=!1}}async function q(e){var t,l,a;i.value=!0,s.value=null;try{const r=(await f.post(`/api/deals/${e}/convert`)).data.data,o=c.value.findIndex(u=>u.id===e);return o!==-1&&(c.value[o]=r.deal),((t=d.value)==null?void 0:t.id)===e&&(d.value=r.deal),r}catch(n){throw s.value=((a=(l=n.response)==null?void 0:l.data)==null?void 0:a.error)||"Failed to convert deal to project",n}finally{i.value=!1}}async function J(e){var t,l,a,n;i.value=!0,s.value=null;try{return await f.delete(`/api/deals/${e}`),c.value=c.value.filter(r=>r.id!==e),p.value&&((t=p.value.columns)==null||t.forEach(r=>{const o=r.deals.findIndex(u=>u.id===e);if(o!==-1){const u=r.deals[o];r.deals.splice(o,1),r.deal_count--,r.total_value-=parseFloat(u.value||0)}})),((l=d.value)==null?void 0:l.id)===e&&(d.value=null),!0}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to delete deal",r}finally{i.value=!1}}async function W(e,t){var l,a,n;i.value=!0,s.value=null;try{const o=(await f.post(`/api/deals/${e}/activities`,t)).data.data;return((l=d.value)==null?void 0:l.id)===e&&(d.value.activities||(d.value.activities=[]),d.value.activities.unshift(o)),o}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to add activity",r}finally{i.value=!1}}async function z(e,t=50,l=0){var a,n;try{return(await f.get(`/api/deals/${e}/activities`,{params:{limit:t,offset:l}})).data.data}catch(r){throw s.value=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.error)||"Failed to fetch activities",r}}async function G(e,t){var l,a;i.value=!0,s.value=null;try{return await f.put("/api/deals/reorder",{stage_id:e,order:t}),!0}catch(n){throw s.value=((a=(l=n.response)==null?void 0:l.data)==null?void 0:a.error)||"Failed to reorder deals",n}finally{i.value=!1}}function H(e){_.value=e}function M(e){F.value=e}function N(e){g.value=e}function Q(){s.value=null}function R(){c.value=[],d.value=null,p.value=null,i.value=!1,s.value=null,_.value="",F.value=null,g.value="all"}function U(e,t,l,a){var v,h;if(!p.value)return;const n=(v=p.value.columns)==null?void 0:v.find(y=>y.stage.id===e),r=(h=p.value.columns)==null?void 0:h.find(y=>y.stage.id===t);if(!n||!r)return;const o=n.deals.findIndex(y=>y.id===l);if(o===-1)return;const[u]=n.deals.splice(o,1);n.deal_count--,n.total_value-=parseFloat(u.value||0),u.stage_id=t,u.sort_order=a,r.deals.splice(a,0,u),r.deal_count++,r.total_value+=parseFloat(u.value||0),r.deals.sort((y,V)=>(y.sort_order||0)-(V.sort_order||0))}return{deals:c,currentDeal:d,kanbanBoard:p,loading:i,error:s,searchTerm:_,pipelineFilter:F,statusFilter:g,activeDeals:D,filteredDeals:x,dealCount:b,activeDealCount:$,dealStats:C,fetchDeals:k,fetchDeal:L,fetchKanbanBoard:S,fetchDealStats:A,fetchClosingSoon:E,fetchOverdue:I,createDeal:T,updateDeal:j,moveDeal:B,markWon:K,markLost:P,convertToProject:q,deleteDeal:J,addActivity:W,fetchActivities:z,reorderDeals:G,setSearchTerm:H,setPipelineFilter:M,setStatusFilter:N,clearError:Q,reset:R,updateKanbanLocally:U}});export{O as u};
