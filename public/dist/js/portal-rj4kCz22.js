import{J as K,r as c,q as F}from"./main-DU1UAF-x.js";import{a as n}from"./index-B9ygI19o.js";const Y=K("portal",()=>{const m=c(!1),d=c(null),w=c(null),y=c([]),i=c([]),P=c([]),g=c(null),v=c(null),o=c(!1),r=c(null),k=c([]),I=F(()=>y.value.filter(t=>["sent","viewed","overdue"].includes(t.status))),T=F(()=>y.value.filter(t=>t.status==="paid")),$=F(()=>i.value.filter(t=>["sent","viewed"].includes(t.status))),S=F(()=>I.value.reduce((t,l)=>t+parseFloat(l.total||0),0)),b=F(()=>{var t;return((t=d.value)==null?void 0:t.name)||"Guest"});async function x(t){var l,e;o.value=!0,r.value=null;try{return(await n.post("/api/portal/request-access",{email:t})).data}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to send access link",a}finally{o.value=!1}}async function j(t){var l,e;o.value=!0,r.value=null;try{const s=(await n.post("/api/portal/authenticate",{token:t})).data.data;return w.value=s.portal_token,d.value=s.client,m.value=!0,n.defaults.headers.common["X-Portal-Token"]=s.portal_token,localStorage.setItem("portalToken",s.portal_token),s}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Invalid or expired access link",a}finally{o.value=!1}}async function L(){const t=localStorage.getItem("portalToken");if(!t)return!1;o.value=!0,r.value=null;try{n.defaults.headers.common["X-Portal-Token"]=t;const e=(await n.get("/api/portal/session")).data.data;return w.value=t,d.value=e.client,m.value=!0,!0}catch{return localStorage.removeItem("portalToken"),delete n.defaults.headers.common["X-Portal-Token"],!1}finally{o.value=!1}}function _(){m.value=!1,d.value=null,w.value=null,y.value=[],i.value=[],P.value=[],g.value=null,v.value=null,k.value=[],localStorage.removeItem("portalToken"),delete n.defaults.headers.common["X-Portal-Token"]}async function M(){var t,l;o.value=!0,r.value=null;try{const e=await n.get("/api/portal/invoices");return y.value=e.data.data||[],y.value}catch(e){throw r.value=((l=(t=e.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch invoices",e}finally{o.value=!1}}async function R(t){var l,e;o.value=!0,r.value=null;try{const a=await n.get(`/api/portal/invoices/${t}`);return g.value=a.data.data,g.value}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to fetch invoice",a}finally{o.value=!1}}async function U(t){var l,e;try{const a=await n.get(`/api/portal/invoices/${t}/pdf`,{responseType:"blob"}),s=window.URL.createObjectURL(new Blob([a.data])),u=document.createElement("a");u.href=s;const p=a.headers["content-disposition"];let f=`invoice-${t}.pdf`;if(p){const h=p.match(/filename="?(.+)"?/);h&&(f=h[1])}return u.setAttribute("download",f),document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(s),!0}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to download PDF",a}}async function X(){var t,l;o.value=!0,r.value=null;try{const e=await n.get("/api/portal/proposals");return i.value=e.data.data||[],i.value}catch(e){throw r.value=((l=(t=e.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch proposals",e}finally{o.value=!1}}async function q(t){var l,e;o.value=!0,r.value=null;try{const a=await n.get(`/api/portal/proposals/${t}`);return v.value=a.data.data,v.value}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to fetch proposal",a}finally{o.value=!1}}async function D(t,l){var e,a,s;o.value=!0,r.value=null;try{const p=(await n.post(`/api/portal/proposals/${t}/accept`,l)).data.data,f=i.value.findIndex(h=>h.id===t);return f!==-1&&(i.value[f]=p),((e=v.value)==null?void 0:e.id)===t&&(v.value=p),p}catch(u){throw r.value=((s=(a=u.response)==null?void 0:a.data)==null?void 0:s.error)||"Failed to accept proposal",u}finally{o.value=!1}}async function O(t,l=""){var e,a,s;o.value=!0,r.value=null;try{const p=(await n.post(`/api/portal/proposals/${t}/reject`,{reason:l})).data.data,f=i.value.findIndex(h=>h.id===t);return f!==-1&&(i.value[f]=p),((e=v.value)==null?void 0:e.id)===t&&(v.value=p),p}catch(u){throw r.value=((s=(a=u.response)==null?void 0:a.data)==null?void 0:s.error)||"Failed to reject proposal",u}finally{o.value=!1}}async function A(t){var l,e;o.value=!0,r.value=null;try{const a=await n.get(`/api/portal/invoices/${t}/payment-methods`);return k.value=a.data.data||[],k.value}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to fetch payment methods",a}finally{o.value=!1}}async function E(t){var l,e;o.value=!0,r.value=null;try{return(await n.post(`/api/portal/invoices/${t}/pay/stripe`)).data.data}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to create payment",a}finally{o.value=!1}}async function B(t){var l,e;o.value=!0,r.value=null;try{return(await n.post(`/api/portal/invoices/${t}/pay/paypal`)).data.data}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to create PayPal order",a}finally{o.value=!1}}async function C(t){var l,e;o.value=!0,r.value=null;try{return(await n.post("/api/portal/payments/paypal/capture",{order_id:t})).data.data}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to capture payment",a}finally{o.value=!1}}async function G(t,l,e=""){var a,s;o.value=!0,r.value=null;try{return(await n.post(`/api/portal/invoices/${t}/pay/manual`,{payment_method:l,reference:e})).data.data}catch(u){throw r.value=((s=(a=u.response)==null?void 0:a.data)==null?void 0:s.error)||"Failed to record payment",u}finally{o.value=!1}}async function J(t,l){var e,a;o.value=!0,r.value=null;try{return(await n.get(`/api/portal/invoices/${t}/payment-instructions/${l}`)).data.data}catch(s){throw r.value=((a=(e=s.response)==null?void 0:e.data)==null?void 0:a.error)||"Failed to get payment instructions",s}finally{o.value=!1}}async function N(){var t,l;o.value=!0,r.value=null;try{const e=await n.get("/api/portal/payments");return P.value=e.data.data||[],P.value}catch(e){throw r.value=((l=(t=e.response)==null?void 0:t.data)==null?void 0:l.error)||"Failed to fetch payments",e}finally{o.value=!1}}async function W(t){var l,e;o.value=!0,r.value=null;try{const a=await n.put("/api/portal/profile",t);return d.value=a.data.data,d.value}catch(a){throw r.value=((e=(l=a.response)==null?void 0:l.data)==null?void 0:e.error)||"Failed to update profile",a}finally{o.value=!1}}function z(){r.value=null}function H(){m.value=!1,d.value=null,w.value=null,y.value=[],i.value=[],P.value=[],g.value=null,v.value=null,o.value=!1,r.value=null,k.value=[]}return{isAuthenticated:m,client:d,portalToken:w,invoices:y,proposals:i,payments:P,currentInvoice:g,currentProposal:v,loading:o,error:r,paymentMethods:k,unpaidInvoices:I,paidInvoices:T,pendingProposals:$,totalDue:S,clientName:b,requestMagicLink:x,authenticateWithToken:j,restoreSession:L,logout:_,fetchInvoices:M,fetchInvoice:R,downloadInvoicePdf:U,fetchProposals:X,fetchProposal:q,acceptProposal:D,rejectProposal:O,fetchPaymentMethods:A,createStripeIntent:E,createPayPalOrder:B,capturePayPalPayment:C,recordManualPayment:G,getPaymentInstructions:J,fetchPayments:N,updateProfile:W,clearError:z,reset:H}});export{Y as u};
